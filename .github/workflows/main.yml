name: Daily WebSocket Test

on:
  schedule:
    - cron: '0 10 * * *'  # 每天10点运行
  workflow_dispatch:  # 允许手动触发

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build and start Docker container
      run: |
        docker build -t dy-danmu .
        docker run -d -p 4200:4200 dy-danmu
        sleep 30  # 等待服务完全启动

    - name: Install wscat
      run: npm install -g wscat

    - name: Create output directory
      run: mkdir -p output

    - name: Test WebSocket connection
      run: |
        wscat -c ws://127.0.0.1:4200 -x '{"url":"https://live.douyin.com/208823316033"}' | head -n 10 > output/test_result.txt

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: output/
